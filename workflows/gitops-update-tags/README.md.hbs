# {{name}}

Automate image tag updates in GitOps repositories using kustomize.

This workflow provides automated image tag updates for ArgoCD-managed applications:

- **Tag Updates** - Updates image tags in kustomization.yaml files
- **PR Grouping** - Groups multiple tag updates in a single pull request
- **Validation** - Validates application and image names before updating
- **Auto-formatting** - Formats files after kustomize edits

## Repository Requirements

Your repository must follow this structure:

### Directory Structure

```
your-gitops-repo/
├── k8s/
│   └── applications/
│       ├── staging/
│       │   └── kustomization.yaml    # Contains images configuration
│       └── production/
│           └── kustomization.yaml
└── .github/
    └── workflows/
        └── update-tags.yaml          # Your workflow using this
```

### Kustomization Format

Your `kustomization.yaml` must include an `images` section:

```yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

images:
  - name: image # Image identifier
    newName: ghcr.io/my-org/my-app
    newTag: v1.2.3

  - name: api-image # Another image
    newName: ghcr.io/my-org/my-api
    newTag: v1.0.0
```

The `name` field in the images array is the identifier used in the `image` input parameter.

## How It Works

### 1. Cherry-pick Pattern

The workflow groups multiple tag updates in a single PR:

1. First update creates a new branch and PR
2. Subsequent updates cherry-pick existing commits before adding new ones
3. Result: Single PR with all tag updates

**Example:**

```
10:00 - Update api-image to v1.2.3
        → Creates branch: fix/tag-update/staging
        → Creates PR with 1 commit

10:05 - Update worker-image to v1.2.4
        → Cherry-picks api-image commit
        → Adds worker-image commit
        → Updates same PR (now 2 commits)

10:10 - PR merged with both updates
```

### 2. Tag Update Process

1. Validates application directory exists
2. Validates image name exists in kustomization.yaml
3. Uses `kustomize edit set image` to update tag
4. Formats files with prettier
5. Creates/updates pull request

### 3. Kustomize Edit Command

The workflow runs:

```bash
kustomize edit set image <image-name>=*:<new-tag>
```

This updates the `newTag` field for the specified image in `kustomization.yaml`.

## Integration Examples

### Trigger from Docker Build Workflow

After building and pushing a Docker image, trigger this workflow to update GitOps:

```yaml
- name: Trigger GitOps Update
  uses: peter-evans/repository-dispatch@v3
  with:
    token: ${{ secrets.DISPATCH_TOKEN }}
    repository: my-org/my-gitops-repo
    event-type: update-tags
    client-payload: |
      {
        "application": "staging",
        "tag": "v${{ steps.version.outputs.tag }}",
        "image": "api-image"
      }
```

### Workflow Dispatch API

Trigger via GitHub API:

```bash
curl -X POST \
  -H "Authorization: Bearer $GITHUB_TOKEN" \
  -H "Accept: application/vnd.github+json" \
  https://api.github.com/repos/my-org/my-gitops-repo/actions/workflows/update-tags.yaml/dispatches \
  -d '{
    "ref": "main",
    "inputs": {
      "application": "staging",
      "tag": "v1.2.3",
      "image": "api-image"
    }
  }'
```

### Multiple Images

Update multiple images in sequence:

```yaml
jobs:
  update-api:
    uses: abinnovision/actions/.github/workflows/workflow.yaml@gitops-update-tags-v1
    with:
      application: staging
      tag: v1.2.3
      image: api-image

  update-worker:
    uses: abinnovision/actions/.github/workflows/workflow.yaml@gitops-update-tags-v1
    with:
      application: staging
      tag: v1.2.4
      image: worker-image
```

Both updates will be grouped in the same PR automatically.

## Advanced Configuration

### Using GCP Authentication

If you need GCP authentication to access resources during the workflow:

```yaml
with:
  use-gcp-auth: true
secrets:
  GCP_AUTH: ${{ vars.GCP_AUTH }}
```

### Custom Applications Directory

```yaml
with:
  applications-directory: manifests/apps
```

### Custom Branch Name

The workflow uses the branch pattern: `fix/tag-update/<application>`

For application "staging", the branch will be: `fix/tag-update/staging`

## Troubleshooting

### Image Not Found Error

**Problem:** `Image 'my-image' not found in kustomization.yaml`

**Solution:**

1. Check the `images` array in your `kustomization.yaml`
2. Ensure the `name` field matches your `image` input parameter
3. The `name` is an identifier, not the full image path

### Application Directory Not Found

**Problem:** `Application directory not found: k8s/applications/staging`

**Solution:**

1. Verify the application directory exists
2. Check `applications-directory` input matches your repo structure
3. Ensure the `application` input parameter is correct

### Cherry-pick Conflicts

**Problem:** Cherry-pick fails when updating existing PR

**Solution:**

The workflow will automatically skip failed cherry-picks and continue. If this happens frequently:

1. Merge PRs more frequently
2. Don't make manual changes to update branches
3. Let the automated workflow manage the branches

## Usage

{{{usage-example type="workflow" name=name inputs=inputs secrets=secrets version=version}}}

## Latest versions

{{{version-examples type="workflow" name=name version=version}}}

## Inputs

{{> inputs-table inputs}}

## Secrets

{{> secrets-table secrets}}

## Outputs

{{> outputs-table outputs}}
